<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<title>Bookmarklet Kode OTP</title>
<style>
    body {font-family: monospace, sans-serif;background: #f4f6f8;color: #333;padding: 20px;}p {font-family: monospace}h1 {color: #2c3e50;font-size: 24px;}.container {background: white;padding: 20px;border-radius: 10px;max-width: 40em;margin: auto;box-shadow: 0 4px 10px rgba(0,0,0,0.1);}input[type="file"], input[type="text"] {margin-top: 10px;padding: 8px;font-family: monospace;border: 1px solid #ccc;border-radius: 6px;background: #f9f9f9;width: 100%;box-sizing: border-box;}#output {background: #1e1e1e;color: #00ff88;padding: 15px;border-radius: 6px;margin-top: 20px;font-family: monospace;white-space: pre-wrap;max-height: 400px;overflow-y: auto;}button {margin-top: 15px;padding: 8px 12px;background: #3498db;color: white;border: none;border-radius: 6px;cursor: pointer;font-family: monospace;}button:hover {background: #2980b9;}.radio-group {display: flex;gap: 15px;margin: 10px 0;}.radio-group label {display: flex;align-items: center;gap: 5px;cursor: pointer;transition: 0.2s;}.radio-group input[type="radio"] {accent-color: #007bff;transform: scale(1.2);}.footer {margin-top: 2rem;text-align: center;font-size: 0.875rem;color: #6b7280;}.footer a {color: #3b82f6;font-weight: 600;text-decoration: none;}.footer a:hover {text-decoration: underline;}
    /* CSS untuk fitur lama */
    .saved-item {background: #f9f9f9;border: 1px solid #ddd;border-radius: 6px;padding: 10px;margin-bottom: 10px;display: flex;justify-content: space-between;align-items: center;}
    .saved-item-info {flex-grow: 1;}
    .saved-item-actions button {margin-left: 5px;padding: 5px 10px;font-size: 0.9em;}
    
    /* CSS untuk fitur baru */
    /* Drag & Drop Zone */
    .drop-zone {border: 2px dashed #ccc;border-radius: 6px;padding: 40px;text-align: center;color: #aaa;cursor: pointer;transition: all 0.3s ease;background: #fafafa;}
    .drop-zone:hover, .drop-zone.drag-over {border-color: #3498db;background: #eef7ff;color: #3498db;}
    .drop-zone i {font-size: 48px;margin-bottom: 10px;}
    #fileInput, #browserBookmarksInput {display: none;} /* Sembunyikan input file asli */

    /* Progress Indicator (Spinner) */
    .progress-indicator {display: none; /* Sembunyikan secara default */text-align: center;margin: 20px 0;}
    .spinner {border: 4px solid #f3f3f3;border-top: 4px solid #3498db;border-radius: 50%;width: 40px;height: 40px;animation: spin 1s linear infinite;margin: 0 auto;}
    @keyframes spin {0% { transform: rotate(0deg); }100% { transform: rotate(360deg); }}

    /* QR History */
    .history-container {margin-top: 20px;}
    .history-item {background: #f9f9f9;border: 1px solid #ddd;border-radius: 6px;padding: 10px;margin-bottom: 8px;cursor: pointer;transition: background-color 0.2s;}
    .history-item:hover {background-color: #eef7ff;}
    .history-item .timestamp {font-size: 0.8em;color: #888;}
</style>
</head>
<body>
<div class="container">
    <h1>‚≠ê Bookmarklet Kode OTP</h1>
    <hr>
    <h3 style="margin-bottom: 5px">üëâ Generator Bookmarklet</h3>
    <p style="margin-top:0">Bookmarklet ini berfungsi untuk menghasilkan kode OTP sesuai secret yang Anda masukkan. Kode OTP akan langsung terisi sesuai penggunaan OTP yang Anda buat.</p>
    <input type="text" id="bookmarkletCode" placeholder="Masukkan Kode Secret">
    <input type="text" id="bookmarkletNama" placeholder="Masukkan Nama Bookmarklet">
    <div class="radio-group">
        <p style="font-family: monospace, sans-serif;margin:0">Pilih Penggunaan OTP:</p>
        <label><input type="radio" name="bmOption" value="kode2fa" checked> Dapodik</label>
        <label><input type="radio" name="bmOption" value="totp_code"> SDM</label>
        <label><input type="radio" name="bmOption" value="infogtk"> InfoGTK</label>
        <label><input type="radio" name="bmOption" value="otp"> SIASN</label>
    </div>
    <button onclick="generateBookmarklet()">Generate Bookmarklet</button>
    <p style="margin: 24px 0;font-family: monospace, sans-serif">Bookmarklet: <a id="bookmarkletLink" href="#" target="_blank"></a></p>
    
    <hr>
    <h3>üëâ Daftar Bookmarklet Tersimpan</h3>
    <p>Bookmarklet yang Anda simpan akan muncul di sini. Klik "Generate" untuk membuat linknya kembali.</p>
    <div id="savedBookmarklets"></div>
    <button onclick="backupData()">üíæ Backup Data</button>
    <input type="file" id="restoreFileInput" accept=".json" style="display:none;">
    <button onclick="document.getElementById('restoreFileInput').click()">üìÇ Restore Data</button>

    <hr>
    <h3 style="margin-bottom: 5px">üëâ Google Authenticator QR Decoder</h3>
    <p style="margin-top:0">Seret dan lepas gambar kode QR ke area di bawah, atau klik untuk memilih file.</p>
    
    <!-- Progress Indicator -->
    <div class="progress-indicator" id="progressIndicator">
        <div class="spinner"></div>
        <p>Sedang memproses...</p>
    </div>

    <!-- Drag & Drop Zone -->
    <div class="drop-zone" id="dropZone">
        <i>üìÅ</i>
        <p>Seret gambar QR ke sini atau klik untuk memilih</p>
        <input type="file" id="fileInput" accept="image/*">
    </div>

    <pre id="output">Silakan Upload QR Google Authenticator</pre>
    
    <!-- QR History Section -->
    <div class="history-container">
        <h3>üëâ Riwayat QR Code</h3>
        <div id="qrHistory"></div>
        <button onclick="clearHistory()" style="background:#e74c3c;">Hapus Riwayat</button>
    </div>

    <!-- FITUR BARU: Impor dari Browser -->
    <hr>
    <h3>üëâ Impor Bookmarklet dari Browser</h3>
    <p style="margin-top:0;">Jika Anda sudah memasang banyak bookmarklet OTP, Anda bisa mengimpornya semua sekaligus.</p>
    <ol style="font-family: monospace; font-size: 0.9em; padding-left: 20px;">
        <li>Buka <strong>Bookmark Manager</strong> browser Anda (tekan <kbd>Ctrl+Shift+O</kbd>).</li>
        <li>Klik menu titik tiga (<strong>‚ãÆ</strong>) lalu pilih <strong>Ekspor bookmark</strong>.</li>
        <li>Simpan file <code>bookmarks.html</code> tersebut.</li>
        <li>Unggah file <code>bookmarks.html</code> di bawah ini.</li>
    </ol>
    <input type="file" id="browserBookmarksInput" accept=".html">
    <button onclick="document.getElementById('browserBookmarksInput').click()">üìÇ Unggah bookmarks.html</button>
    <div id="importResult" style="margin-top: 15px; font-weight: bold;"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/protobufjs/dist/protobuf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>
// --- Inisialisasi dan Manajemen Data ---
document.addEventListener('DOMContentLoaded', function() {
    displaySavedBookmarklets();
    document.getElementById('restoreFileInput').addEventListener('change', handleRestoreFile);
    document.getElementById('browserBookmarksInput').addEventListener('change', handleBrowserBookmarksImport);
    
    // Inisialisasi Drag & Drop
    initDragAndDrop();
    
    // Tampilkan riwayat QR saat halaman dimuat
    displayQRHistory();
});

function getSavedBookmarklets() {
    const data = localStorage.getItem('otpBookmarklets');
    return data ? JSON.parse(data) : [];
}

function saveBookmarklets(data) {
    localStorage.setItem('otpBookmarklets', JSON.stringify(data));
}

function displaySavedBookmarklets() {
    const savedData = getSavedBookmarklets();
    const container = document.getElementById('savedBookmarklets');
    if (!container) return;
    container.innerHTML = '';
    if (savedData.length === 0) {
        container.innerHTML = '<p style="color: #888;">Belum ada bookmarklet yang disimpan.</p>';
        return;
    }
    savedData.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'saved-item';
        div.innerHTML = `
            <div class="saved-item-info">
                <strong>${item.nama}</strong> (${item.penggunaan})
            </div>
            <div class="saved-item-actions">
                <button onclick="generateFromSaved(${index})">Generate</button>
                <button onclick="deleteSaved(${index})" style="background:#e74c3c;">Hapus</button>
            </div>
        `;
        container.appendChild(div);
    });
}

function generateFromSaved(index) {
    const savedData = getSavedBookmarklets();
    const item = savedData[index];
    if (item) {
        const codeInput = document.getElementById("bookmarkletCode");
        const namaInput = document.getElementById("bookmarkletNama");
        const radioOption = document.querySelector(`input[name="bmOption"][value="${item.penggunaan}"]`);

        if (codeInput) codeInput.value = item.secret;
        if (namaInput) namaInput.value = item.nama;
        if (radioOption) radioOption.checked = true;

        generateBookmarklet();
    }
}

function deleteSaved(index) {
    if (confirm('Apakah Anda yakin ingin menghapus bookmarklet ini?')) {
        let savedData = getSavedBookmarklets();
        savedData.splice(index, 1);
        saveBookmarklets(savedData);
        displaySavedBookmarklets();
    }
}

// --- Generator Bookmarklet ---
function generateBookmarklet() {
    const codeInput = document.getElementById("bookmarkletCode");
    const namaInput = document.getElementById("bookmarkletNama");
    const selectedRadio = document.querySelector('input[name="bmOption"]:checked');

    if (!codeInput || !namaInput || !selectedRadio) {
        alert("Elemen form tidak ditemukan. Pastikan HTML tidak berubah.");
        return;
    }

    const code = codeInput.value.trim();
    const namacode = namaInput.value.trim();
    const selected2fa = selectedRadio.value;

    if (!code) {
        alert("Masukkan kode secret terlebih dahulu.");
        return;
    } else if (!namacode) {
        alert("Masukkan nama bookmark terlebih dahulu.");
        return;
    }

    let savedData = getSavedBookmarklets();
    if (!savedData.some(item => item.nama === namacode)) {
        savedData.push({ nama: namacode, secret: code, penggunaan: selected2fa });
        saveBookmarklets(savedData);
        displaySavedBookmarklets();
    }

    let jsCode = `var secretKey="${code}";var jadiKey="";function base32Decode(e){for(var t=e.toUpperCase().replace(/=+$/,"").replace(/\\s+/g,""),r=0,n=0,a=[],o=0;o<t.length;o++){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567".indexOf(t[o]);if(-1===c)throw new Error("Invalid Base32 character: "+t[o]);n=n<<5|c,(r+=5)>=8&&(a.push(n>>>r-8&255),r-=8)}return new Uint8Array(a)}function intToBuffer(e){var t=new ArrayBuffer(8),r=new DataView(t),n=Math.floor(e/Math.pow(2,32)),a=e>>>0;return r.setUint32(0,n),r.setUint32(4,a),new Uint8Array(t)}function generateTOTP(e,t,r,n){t=t||6,r=r||30,n=n||"SHA-1";var a=base32Decode(e),o=Math.floor(Date.now()/1e3),c=intToBuffer(Math.floor(o/r));return crypto.subtle.importKey("raw",a,{name:"HMAC",hash:{name:n}},!1,["sign"]).then(function(e){return crypto.subtle.sign("HMAC",e,c)}).then(function(e){var r=new Uint8Array(e),n=15&r[r.length-1];return(((127&r[n])<<24|(255&r[n+1])<<16|(255&r[n+2])<<8|255&r[n+3])%Math.pow(10,t)).toString().padStart(t,"0")})}generateTOTP(secretKey).then(function(e){jadiKey=e;var jotp="${selected2fa}";if("infogtk"==jotp){const e=document.querySelectorAll("#otpForm .otp-input");jadiKey.split("").forEach((t,o)=>{e[o]&&(e[o].value=t)})}else document.getElementById("${selected2fa}").value=e;}).catch(function(e){alert("Error: id tidak ditemukan untuk OTP " + jadiKey)});`;
    const bookmarklet = "javascript:(function(){" + encodeURIComponent(jsCode) + "})();";
    
    const link = document.getElementById("bookmarkletLink");
    if (link) {
        link.href = bookmarklet;
        link.textContent = namacode;
    }
}

// --- Backup & Restore ---
function backupData() {
    const savedData = getSavedBookmarklets();
    if (savedData.length === 0) {
        alert("Tidak ada data untuk dibackup.");
        return;
    }
    const dataStr = JSON.stringify(savedData, null, 2);
    const dataBlob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `otp_bookmarklet_backup_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    alert("Backup berhasil diunduh!");
}

function handleRestoreFile(evt) {
    const file = evt.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const restoredData = JSON.parse(e.target.result);
            if (Array.isArray(restoredData)) {
                saveBookmarklets(restoredData);
                displaySavedBookmarklets();
                alert("Data berhasil dipulihkan!");
            } else {
                throw new Error("Format file tidak valid.");
            }
        } catch (err) {
            alert("Gagal memulihkan data: " + err.message);
        }
    };
    reader.readAsText(file);
    evt.target.value = '';
}

// --- FITUR BARU: Impor dari Browser ---
function handleBrowserBookmarksImport(evt) {
    const file = evt.target.files[0];
    if (!file) return;

    const resultDiv = document.getElementById('importResult');
    resultDiv.textContent = "Sedang memproses file bookmark...";

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const htmlContent = e.target.result;
            const foundBookmarklets = parseBookmarksHTML(htmlContent);

            if (foundBookmarklets.length === 0) {
                resultDiv.textContent = "‚ö†Ô∏è Tidak ditemukan bookmarklet OTP yang dikenali di file tersebut.";
                return;
            }

            let savedData = getSavedBookmarklets();
            let addedCount = 0;
            let skippedCount = 0;

            foundBookmarklets.forEach(item => {
                // Cek duplikat berdasarkan nama
                if (!savedData.some(saved => saved.nama === item.nama)) {
                    savedData.push(item);
                    addedCount++;
                } else {
                    skippedCount++;
                }
            });

            saveBookmarklets(savedData);
            displaySavedBookmarklets();
            
            resultDiv.innerHTML = `‚úÖ Selesai! <strong>${addedCount}</strong> bookmarklet baru ditambahkan. <strong>${skippedCount}</strong> dilewati karena sudah ada.`;

        } catch (err) {
            resultDiv.textContent = "‚ùå Error: Gagal memproses file. " + err.message;
        }
    };
    reader.onerror = function() {
        resultDiv.textContent = "‚ùå Error: Gagal membaca file.";
    };
    reader.readAsText(file);
    evt.target.value = ''; // Reset input
}

function parseBookmarksHTML(htmlContent) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlContent, 'text/html');
    const links = doc.querySelectorAll('a[href^="javascript:"]');
    const foundBookmarklets = [];

    links.forEach(link => {
        const href = link.getAttribute('href');
        const name = link.textContent.trim();

        // Decode the javascript: URL
        let decodedScript;
        try {
            decodedScript = decodeURIComponent(href.substring(11)); // Remove 'javascript:'
        } catch (e) {
            return; // Skip this one
        }

        // Use regex to find the secret key
        const secretMatch = decodedScript.match(/var secretKey="([^"]+)";/);
        if (!secretMatch) {
            return; // Not one of our bookmarklets
        }
        const secret = secretMatch[1];

        // Determine the platform
        let platform = 'unknown';
        if (decodedScript.includes('getElementById("kode2fa")')) platform = 'kode2fa';
        else if (decodedScript.includes('getElementById("totp_code")')) platform = 'totp_code';
        else if (decodedScript.includes('getElementById("infogtk")')) platform = 'infogtk';
        else if (decodedScript.includes('getElementById("otp")')) platform = 'otp';
        
        foundBookmarklets.push({ nama: name, secret: secret, penggunaan: platform });
    });

    return foundBookmarklets;
}


// --- QR Decoder & Fitur Lainnya ---
// Inisialisasi Drag & Drop
function initDragAndDrop() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    dropZone.addEventListener('click', () => fileInput.click());
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
    });
    dropZone.addEventListener('drop', handleDrop, false);
    function handleDrop(e) { const dt = e.dataTransfer; const files = dt.files; if (files.length > 0) { handleFile({ target: { files: files } }); } }
    fileInput.addEventListener('change', handleFile);
}

function toggleProgressIndicator(show) {
    const indicator = document.getElementById('progressIndicator');
    if (indicator) { indicator.style.display = show ? 'block' : 'none'; }
}

function handleFile(evt) {
    const file = evt.target.files[0];
    if (!file) return;
    toggleProgressIndicator(true);
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas'); canvas.width = img.width; canvas.height = img.height;
            const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            toggleProgressIndicator(false);
            if (code) { processQR(code.data); } else { const outputEl = document.getElementById('output'); if (outputEl) outputEl.textContent = "‚ùå QR code tidak terbaca pada gambar ini."; }
        };
        img.onerror = function() { toggleProgressIndicator(false); const outputEl = document.getElementById('output'); if (outputEl) outputEl.textContent = "‚ùå Gagal memuat gambar. Pastikan file adalah gambar yang valid."; };
        img.src = e.target.result;
    };
    reader.onerror = function() { toggleProgressIndicator(false); const outputEl = document.getElementById('output'); if (outputEl) outputEl.textContent = "‚ùå Gagal membaca file."; };
    reader.readAsDataURL(file);
    evt.target.value = '';
}

function processQR(qrText) {
    const outputEl = document.getElementById('output'); if (!outputEl) return;
    try {
        if (qrText.startsWith("otpauth://")) {
            const url = new URL(qrText); const secret = url.searchParams.get("secret"); const issuer = url.searchParams.get("issuer") || "(tidak ada)"; const label = decodeURIComponent(url.pathname.replace(/^\/\//, ''));
            if (secret) {
                const result = { type: 'OTP Auth', name: label, issuer: issuer, secret: secret };
                outputEl.textContent = `üìå ${result.type}\nNama   : ${result.name}\nIssuer : ${result.issuer}\nSecret : ${result.secret}`;
                const codeInput = document.getElementById("bookmarkletCode"); const namaInput = document.getElementById("bookmarkletNama");
                if (codeInput) codeInput.value = result.secret; if (namaInput) namaInput.value = result.name; saveToHistory(result);
            } else { outputEl.textContent = "‚ö†Ô∏è Secret tidak ditemukan di QR."; } return;
        }
        const url = new URL(qrText); let dataParam = url.searchParams.get("data");
        if (!dataParam) { outputEl.textContent = "‚ö†Ô∏è Parameter data= tidak ditemukan pada URL QR."; return; }
        dataParam = dataParam.replace(/ /g, '+').replace(/%20/g, '+').replace(/%2B/gi, '+');
        const binary = atob(dataParam); const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) { bytes[i] = binary.charCodeAt(i); }
        const root = protobuf.Root.fromJSON({ nested: { MigrationPayload: { fields: { otpParameters: { rule: "repeated", type: "OtpParameters", id: 1 }, version: { type: "int32", id: 2 }, batchSize: { type: "int32", id: 3 }, batchIndex: { type: "int32", id: 4 }, batchId: { type: "bytes", id: 5 } } }, OtpParameters: { fields: { secret: { type: "bytes", id: 1 }, name: { type: "string", id: 2 }, issuer: { type: "string", id: 3 }, algorithm: { type: "int32", id: 4 }, digits: { type: "int32", id: 5 }, type: { type: "int32", id: 6 }, counter: { type: "int64", id: 7 } } } } });
        const MigrationPayload = root.lookupType("MigrationPayload"); const payload = MigrationPayload.decode(bytes);
        if (!payload.otpParameters || payload.otpParameters.length === 0) { outputEl.textContent = "‚ö†Ô∏è Tidak ada akun ditemukan di payload migrasi."; return; }
        let resultText = ""; payload.otpParameters.forEach((param, i) => {
            const secretBase32 = base32Encode(param.secret); const result = { type: 'Migration Payload', name: param.name, issuer: param.issuer, secret: secretBase32 };
            resultText += `üìå Akun ${i+1}\nNama   : ${result.name}\nIssuer : ${result.issuer}\nSecret : ${result.secret}\n\n`; saveToHistory(result);
        }); outputEl.textContent = resultText;
    } catch (err) { outputEl.textContent = "‚ùå Error saat memproses QR: " + err.message; }
}

// --- QR History Management ---
function getQRHistory() { const history = localStorage.getItem('qrScanHistory'); return history ? JSON.parse(history) : []; }
function saveToHistory(data) { let history = getQRHistory(); if (!history.some(item => item.secret === data.secret)) { data.timestamp = new Date().toISOString(); history.unshift(data); if (history.length > 20) { history = history.slice(0, 20); } localStorage.setItem('qrScanHistory', JSON.stringify(history)); displayQRHistory(); } }
function displayQRHistory() { const history = getQRHistory(); const container = document.getElementById('qrHistory'); if (!container) return; container.innerHTML = ''; if (history.length === 0) { container.innerHTML = '<p style="color: #888;">Belum ada riwayat QR code.</p>'; return; } history.forEach((item, index) => { const div = document.createElement('div'); div.className = 'history-item'; const date = new Date(item.timestamp).toLocaleString('id-ID'); div.innerHTML = `<strong>${item.name}</strong> (${item.issuer})<div class="timestamp">${date}</div>`; div.onclick = () => useHistoryItem(item); container.appendChild(div); }); }
function useHistoryItem(item) { const codeInput = document.getElementById("bookmarkletCode"); const namaInput = document.getElementById("bookmarkletNama"); if (codeInput) codeInput.value = item.secret; if (namaInput) namaInput.value = item.name; }
function clearHistory() { if (confirm('Apakah Anda yakin ingin menghapus semua riwayat QR code?')) { localStorage.removeItem('qrScanHistory'); displayQRHistory(); } }

function base32Encode(bytes) {
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567'; let bits = 0, value = 0, output = '';
    for (let i = 0; i < bytes.length; i++) { value = (value << 8) | bytes[i]; bits += 8; while (bits >= 5) { output += alphabet[(value >>> (bits - 5)) & 31]; bits -= 5; } }
    if (bits > 0) { output += alphabet[(value << (5 - bits)) & 31]; } return output;
}
</script>
</body>
</html>
