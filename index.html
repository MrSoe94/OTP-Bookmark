<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bookmarklet Kode OTP</title>
<style>
    /* --- Perubahan untuk Full-Screen --- */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        background: #f4f6f8;
    }

    body {
        font-family: monospace, sans-serif;
        color: #333;
        font-size: 18px;
    }

    .container {
        display: flex;
        flex-direction: column;
        background: white;
        min-height: 100vh;
        width: 95%;
        margin: 0 auto;
        padding: 20px;
        box-sizing: border-box;
        border-radius: 10px 10px 0 0;
        box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
    }
    
    h1 {color: #2c3e50; font-size: 28px;}
    h3 { font-size: 20px; margin-top: 20px; }
    
    p {font-family: monospace}
    input[type="file"], input[type="text"], textarea {
        margin-top: 10px;
        padding: 10px;
        font-family: monospace;
        border: 1px solid #ccc;
        border-radius: 6px;
        background: #f9f9f9;
        width: 100%;
        box-sizing: border-box;
        font-size: 16px;
    }

    /* Output Fleksibel */
    #output {
        background: #1e1e1e;
        color: #00ff88;
        padding: 15px;
        border-radius: 6px;
        margin-top: 20px;
        font-family: monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
        min-height: 50px;
        height: auto;
        overflow: visible;
        font-size: 16px;
        border: 1px solid #333;
    }

    button {
        margin-top: 15px;
        padding: 10px 15px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-family: monospace;
        font-size: 16px;
    }
    button:hover {background: #2980b9;}

    .radio-group {
        display: flex;
        gap: 15px;
        margin: 10px 0;
        flex-wrap: wrap;
        font-size: 16px;
    }
    .radio-group label {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
    }

    .footer {
        margin-top: 40px;
        padding: 20px 0;
        text-align: center;
        font-size: 16px;
        color: #6b7280;
    }

    .saved-item {
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 16px;
    }

    .drop-zone {
        border: 2px dashed #ccc;
        border-radius: 6px;
        padding: 40px;
        text-align: center;
        color: #aaa;
        cursor: pointer;
        background: #fafafa;
        font-size: 16px;
    }
    .drop-zone:hover, .drop-zone.drag-over {
        border-color: #3498db;
        background: #eef7ff;
        color: #3498db;
    }

    #savedBookmarklets, #qrHistory {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #eee;
        padding: 10px;
        border-radius: 6px;
        background-color: #fdfdfd;
    }

    .history-item {
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 8px;
        cursor: pointer;
        font-size: 16px;
    }
    .history-item .timestamp {
        font-size: 14px;
        color: #888;
    }
</style>
</head>
<body>
<div class="container">
    <h1>‚≠ê Bookmarklet Kode OTP</h1>
    <hr>
    <h3>üëâ Generator Bookmarklet</h3>
    <p>Masukkan secret key Anda untuk membuat bookmarklet pengisi OTP otomatis.</p>
    <input type="text" id="bookmarkletCode" placeholder="Masukkan Kode Secret (Base32)">
    <input type="text" id="bookmarkletNama" placeholder="Contoh: Akun Dapodik Saya">
    <div class="radio-group">
        <p style="width:100%; margin-bottom:5px;">Pilih Target Input:</p>
        <label><input type="radio" name="bmOption" value="kode2fa" checked> Dapodik</label>
        <label><input type="radio" name="bmOption" value="totp_code"> SDM</label>
        <label><input type="radio" name="bmOption" value="infogtk"> InfoGTK</label>
        <label><input type="radio" name="bmOption" value="otp"> SIASN</label>
    </div>
    <button onclick="generateBookmarklet()">Generate Bookmarklet</button>
    <p>Link Bookmarklet: <a id="bookmarkletLink" href="#" style="font-weight:bold; color:#3498db;">(Belum dibuat)</a></p>
    
    <hr>
    <h3>üëâ Daftar Tersimpan</h3>
    <div id="savedBookmarklets"></div>
    <div style="display: flex; gap: 10px;">
        <button onclick="backupData()">üíæ Backup</button>
        <input type="file" id="restoreFileInput" accept=".json" style="display:none;">
        <button onclick="document.getElementById('restoreFileInput').click()">üìÇ Restore</button>
    </div>

    <hr>
    <h3>üëâ Google Authenticator QR Decoder</h3>
    <div class="drop-zone" id="dropZone">
        <i>üì∑</i>
        <p>Lepaskan gambar QR di sini atau klik untuk memilih file</p>
        <input type="file" id="fileInput" accept="image/*" style="display:none;">
    </div>

    <pre id="output">Hasil dekode QR akan muncul di sini...</pre>
    
    <div class="history-container">
        <h3>üëâ Riwayat QR</h3>
        <div id="qrHistory"></div>
        <button onclick="clearHistory()" style="background:#e74c3c;">Hapus Riwayat</button>
    </div>

    <hr>
    <h3>üëâ Impor dari Browser</h3>
    <p style="font-size: 14px;">Upload file <code>bookmarks.html</code> hasil ekspor dari browser Anda.</p>
    <input type="file" id="browserBookmarksInput" accept=".html" style="display:none;">
    <button onclick="document.getElementById('browserBookmarksInput').click()">üìÇ Unggah bookmarks.html</button>
    <div id="importResult" style="margin-top: 10px; font-size: 14px;"></div>

    <div class="footer">
        Dibuat untuk mempermudah manajemen OTP &copy; 2024
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/protobufjs/dist/protobuf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    displaySavedBookmarklets();
    displayQRHistory();
    initDragAndDrop();
    document.getElementById('restoreFileInput').addEventListener('change', handleRestoreFile);
    document.getElementById('browserBookmarksInput').addEventListener('change', handleBrowserBookmarksImport);
});

function getSavedBookmarklets() {
    return JSON.parse(localStorage.getItem('otpBookmarklets') || '[]');
}

function saveBookmarklets(data) {
    localStorage.setItem('otpBookmarklets', JSON.stringify(data));
}

function displaySavedBookmarklets() {
    const savedData = getSavedBookmarklets();
    const container = document.getElementById('savedBookmarklets');
    container.innerHTML = savedData.length ? '' : '<p style="color:#888">Belum ada data.</p>';
    savedData.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'saved-item';
        div.innerHTML = `
            <div><strong>${item.nama}</strong> <small>(${item.penggunaan})</small></div>
            <div>
                <button onclick="generateFromSaved(${index})">Pakai</button>
                <button onclick="deleteSaved(${index})" style="background:#e74c3c;">X</button>
            </div>
        `;
        container.appendChild(div);
    });
}

function generateFromSaved(index) {
    const savedData = getSavedBookmarklets();
    const item = savedData[index];
    if (item) {
        document.getElementById("bookmarkletCode").value = item.secret;
        document.getElementById("bookmarkletNama").value = item.nama;
        const radio = document.querySelector(`input[name="bmOption"][value="${item.penggunaan}"]`);
        if (radio) radio.checked = true;
        generateBookmarklet();
    }
}

function deleteSaved(index) {
    if (confirm('Hapus bookmarklet ini?')) {
        let savedData = getSavedBookmarklets();
        savedData.splice(index, 1);
        saveBookmarklets(savedData);
        displaySavedBookmarklets();
    }
}

function generateBookmarklet() {
    const code = document.getElementById("bookmarkletCode").value.trim();
    const nama = document.getElementById("bookmarkletNama").value.trim();
    const target = document.querySelector('input[name="bmOption"]:checked').value;

    if (!code || !nama) return alert("Isi semua field!");

    let savedData = getSavedBookmarklets();
    if (!savedData.some(i => i.nama === nama)) {
        savedData.push({ nama, secret: code, penggunaan: target });
        saveBookmarklets(savedData);
        displaySavedBookmarklets();
    }

    const jsCode = `var secretKey="${code}";function base32Decode(e){for(var t=e.toUpperCase().replace(/=+$/,"").replace(/\\s+/g,""),r=0,n=0,a=[],o=0;o<t.length;o++){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567".indexOf(t[o]);if(-1===c)throw new Error("Invalid Base32 character: "+t[o]);n=n<<5|c,(r+=5)>=8&&(a.push(n>>>r-8&255),r-=8)}return new Uint8Array(a)}function intToBuffer(e){var t=new ArrayBuffer(8),r=new DataView(t),n=Math.floor(e/Math.pow(2,32)),a=e>>>0;return r.setUint32(0,n),r.setUint32(4,a),new Uint8Array(t)}function generateTOTP(e,t,r,n){t=t||6,r=r||30,n=n||"SHA-1";var a=base32Decode(e),o=Math.floor(Date.now()/1e3),c=intToBuffer(Math.floor(o/r));return crypto.subtle.importKey("raw",a,{name:"HMAC",hash:{name:n}},!1,["sign"]).then(f=>crypto.subtle.sign("HMAC",f,c)).then(f=>{var r=new Uint8Array(f),n=15&r[r.length-1];return(((127&r[n])<<24|(255&r[n+1])<<16|(255&r[n+2])<<8|255&r[n+3])%Math.pow(10,t)).toString().padStart(t,"0")})}generateTOTP(secretKey).then(k=>{var j="${target}";if(j=="infogtk"){document.querySelectorAll("#otpForm .otp-input").forEach((el,i)=>el.value=k[i])}else{var el=document.getElementById(j);if(el)el.value=k;else alert("Input ID "+j+" tidak ditemukan di halaman ini")}}).catch(e=>alert("Gagal generate OTP"));`;
    
    const link = document.getElementById("bookmarkletLink");
    link.href = "javascript:(function(){" + encodeURIComponent(jsCode) + "})();";
    link.textContent = nama;
}

function initDragAndDrop() {
    const zone = document.getElementById('dropZone');
    const input = document.getElementById('fileInput');
    zone.onclick = () => input.click();
    zone.ondragover = (e) => { e.preventDefault(); zone.classList.add('drag-over'); };
    zone.ondragleave = () => zone.classList.remove('drag-over');
    zone.ondrop = (e) => {
        e.preventDefault();
        zone.classList.remove('drag-over');
        if (e.dataTransfer.files.length) handleQRFile(e.dataTransfer.files[0]);
    };
    input.onchange = (e) => { if (e.target.files.length) handleQRFile(e.target.files[0]); };
}

function handleQRFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width; canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const qr = jsQR(ctx.getImageData(0, 0, canvas.width, canvas.height).data, canvas.width, canvas.height);
            if (qr) processQR(qr.data); else document.getElementById('output').textContent = "QR tidak terdeteksi.";
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function base32Encode(bytes) {
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
    let bits = 0, value = 0, output = '';
    for (let i = 0; i < bytes.length; i++) {
        value = (value << 8) | bytes[i];
        bits += 8;
        while (bits >= 5) {
            output += alphabet[(value >>> (bits - 5)) & 31];
            bits -= 5;
        }
    }
    if (bits > 0) output += alphabet[(value << (5 - bits)) & 31];
    return output;
}

function processQR(data) {
    const out = document.getElementById('output');
    try {
        if (data.startsWith("otpauth://")) {
            const url = new URL(data);
            const secret = url.searchParams.get("secret");
            const name = decodeURIComponent(url.pathname.split(':').pop().replace(/^\/\//, ''));
            out.textContent = `‚úÖ Berhasil Dekode:\nNama: ${name}\nSecret: ${secret}`;
            document.getElementById("bookmarkletCode").value = secret;
            document.getElementById("bookmarkletNama").value = name;
            saveToHistory({ name, secret, issuer: url.searchParams.get("issuer") || "N/A" });
        } else if (data.includes("otpauth-migration")) {
            const url = new URL(data);
            let dataParam = url.searchParams.get("data");
            if (!dataParam) { out.textContent = "Data migrasi tidak ditemukan."; return; }
            
            dataParam = dataParam.replace(/ /g, '+');
            const binary = atob(dataParam);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);

            const root = protobuf.Root.fromJSON({
                nested: {
                    MigrationPayload: {
                        fields: {
                            otpParameters: { rule: "repeated", type: "OtpParameters", id: 1 },
                            version: { type: "int32", id: 2 },
                            batchSize: { type: "int32", id: 3 },
                            batchIndex: { type: "int32", id: 4 },
                            batchId: { type: "bytes", id: 5 }
                        }
                    },
                    OtpParameters: {
                        fields: {
                            secret: { type: "bytes", id: 1 },
                            name: { type: "string", id: 2 },
                            issuer: { type: "string", id: 3 },
                            algorithm: { type: "int32", id: 4 },
                            digits: { type: "int32", id: 5 },
                            type: { type: "int32", id: 6 },
                            counter: { type: "int64", id: 7 }
                        }
                    }
                }
            });

            const MigrationPayload = root.lookupType("MigrationPayload");
            const payload = MigrationPayload.decode(bytes);
            
            if (payload.otpParameters && payload.otpParameters.length > 0) {
                let resultText = `‚úÖ Ditemukan ${payload.otpParameters.length} Akun:\n\n`;
                payload.otpParameters.forEach((p, i) => {
                    const secretB32 = base32Encode(p.secret);
                    resultText += `üìå [${i+1}] ${p.name}\nSecret: ${secretB32}\n\n`;
                    saveToHistory({ name: p.name, secret: secretB32, issuer: p.issuer });
                    if (i === 0) {
                        document.getElementById("bookmarkletCode").value = secretB32;
                        document.getElementById("bookmarkletNama").value = p.name;
                    }
                });
                out.textContent = resultText;
            } else {
                out.textContent = "Payload kosong.";
            }
        } else {
            out.textContent = "Format QR tidak dikenali.";
        }
    } catch (e) {
        out.textContent = "Error Dekode: " + e.message;
    }
}

function saveToHistory(item) {
    let history = JSON.parse(localStorage.getItem('qrScanHistory') || '[]');
    if (!history.some(h => h.secret === item.secret)) {
        item.timestamp = new Date().toISOString();
        history.unshift(item);
        localStorage.setItem('qrScanHistory', JSON.stringify(history.slice(0, 20)));
        displayQRHistory();
    }
}

function displayQRHistory() {
    const history = JSON.parse(localStorage.getItem('qrScanHistory') || '[]');
    const container = document.getElementById('qrHistory');
    container.innerHTML = history.length ? '' : '<p style="color:#888">Belum ada riwayat.</p>';
    history.forEach(item => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `<strong>${item.name}</strong><br><small>${item.secret}</small>`;
        div.onclick = () => {
            document.getElementById("bookmarkletCode").value = item.secret;
            document.getElementById("bookmarkletNama").value = item.name;
        };
        container.appendChild(div);
    });
}

function backupData() {
    const data = localStorage.getItem('otpBookmarklets');
    if(!data) return alert("Tidak ada data.");
    const blob = new Blob([data], {type: "application/json"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `backup_otp_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
}

function handleRestoreFile(e) {
    const reader = new FileReader();
    reader.onload = (ev) => {
        try {
            JSON.parse(ev.target.result);
            localStorage.setItem('otpBookmarklets', ev.target.result);
            displaySavedBookmarklets();
            alert("Restore berhasil!");
        } catch(e) { alert("File JSON tidak valid."); }
    };
    reader.readAsText(e.target.files[0]);
}

function handleBrowserBookmarksImport(e) {
    const reader = new FileReader();
    reader.onload = (ev) => {
        const html = ev.target.result;
        const matches = [...html.matchAll(/var secretKey="([^"]+)";/g)];
        const names = [...html.matchAll(/<A [^>]*>([^<]+)<\/A>/g)];
        
        if (matches.length) {
            let savedData = getSavedBookmarklets();
            let added = 0;
            matches.forEach((m, i) => {
                const secret = m[1];
                const nama = names[i] ? names[i][1] : "Imported OTP";
                if (!savedData.some(s => s.secret === secret)) {
                    savedData.push({ nama, secret, penggunaan: "kode2fa" });
                    added++;
                }
            });
            saveBookmarklets(savedData);
            displaySavedBookmarklets();
            alert(`Berhasil mengimpor ${added} bookmarklet baru.`);
        } else {
            alert("Tidak ditemukan script bookmarklet OTP yang cocok.");
        }
    };
    reader.readAsText(e.target.files[0]);
}

function clearHistory() {
    if(confirm('Hapus riwayat QR?')) {
        localStorage.removeItem('qrScanHistory');
        displayQRHistory();
    }
}
</script>
</body>
</html>
